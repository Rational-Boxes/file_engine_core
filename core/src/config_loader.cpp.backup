#include "config_loader.h"
#include <iostream>
#include <fstream>
#include <sstream>
#include <map>
#include <memory>
#include <cstdlib>
#include <unistd.h>
#include <algorithm>
#include <cctype>

namespace fileengine {

std::string ConfigLoader::get_env_var(const std::string& var, const std::string& default_val) {
    const char* env_val = std::getenv(var.c_str());
    return env_val ? std::string(env_val) : default_val;
}

std::map<std::string, std::string> ConfigLoader::parse_env_file(const std::string& filepath) {
    std::map<std::string, std::string> env_vars;
    std::ifstream file(filepath);

    if (!file.is_open()) {
        return env_vars;  // Return empty map if file can't be opened
    }

    std::string line;
    while (std::getline(file, line)) {
        // Skip comments and empty lines
        if (line.empty() || line[0] == '#' || line[0] == ';') {
            continue;
        }

        // Find the first '=' to split key=value
        size_t pos = line.find('=');
        if (pos != std::string::npos) {
            std::string key = line.substr(0, pos);
            std::string value = line.substr(pos + 1);

            // Trim whitespace
            key.erase(0, key.find_first_not_of(" \t\r\n"));
            key.erase(key.find_last_not_of(" \t\r\n") + 1);
            value.erase(0, value.find_first_not_of(" \t\r\n"));
            value.erase(value.find_last_not_of(" \t\r\n") + 1);

            // Remove quotes if present
            if (value.length() >= 2 && 
                ((value.front() == '"' && value.back() == '"') || 
                 (value.front() == '\'' && value.back() == '\''))) {
                value = value.substr(1, value.length() - 2);
            }

            env_vars[key] = value;
        }
    }

    return env_vars;
}

Config ConfigLoader::load_from_file(const std::string& filepath) {
    Config config;
    auto env_vars = parse_env_file(filepath);
    auto it = env_vars.end();

    // Database configuration
    it = env_vars.find("FILEENGINE_PG_HOST");
    if (it != env_vars.end()) config.db_host = it->second;
    
    it = env_vars.find("FILEENGINE_PG_PORT");
    if (it != env_vars.end()) config.db_port = std::stoi(it->second);
    
    it = env_vars.find("FILEENGINE_PG_DATABASE");
    if (it != env_vars.end()) config.db_name = it->second;
    
    it = env_vars.find("FILEENGINE_PG_USER");
    if (it != env_vars.end()) config.db_user = it->second;
    
    it = env_vars.find("FILEENGINE_PG_PASSWORD");
    if (it != env_vars.end()) config.db_password = it->second;

    // Storage configuration
    it = env_vars.find("FILEENGINE_STORAGE_BASE");
    if (it != env_vars.end()) config.storage_base_path = it->second;

    // Compression and encryption settings
    it = env_vars.find("FILEENGINE_ENCRYPT_DATA");
    if (it != env_vars.end()) config.encrypt_data = (it->second == "true" || it->second == "TRUE" || it->second == "1");
    
    it = env_vars.find("FILEENGINE_COMPRESS_DATA");
    if (it != env_vars.end()) config.compress_data = (it->second == "true" || it->second == "TRUE" || it->second == "1");

    // S3/MinIO configuration
    it = env_vars.find("FILEENGINE_S3_ENDPOINT");
    if (it != env_vars.end()) config.s3_endpoint = it->second;
    
    it = env_vars.find("FILEENGINE_S3_REGION");
    if (it != env_vars.end()) config.s3_region = it->second;
    
    it = env_vars.find("FILEENGINE_S3_BUCKET");
    if (it != env_vars.end()) config.s3_bucket = it->second;
    
    it = env_vars.find("FILEENGINE_S3_ACCESS_KEY");
    if (it != env_vars.end()) config.s3_access_key = it->second;
    
    it = env_vars.find("FILEENGINE_S3_SECRET_KEY");
    if (it != env_vars.end()) config.s3_secret_key = it->second;
    
    it = env_vars.find("FILEENGINE_S3_PATH_STYLE");
    if (it != env_vars.end()) config.s3_path_style = (it->second == "true" || it->second == "TRUE" || it->second == "1");

    // Cache configuration
    it = env_vars.find("FILEENGINE_CACHE_THRESHOLD");
    if (it != env_vars.end()) config.cache_threshold = std::stod(it->second);
    
    it = env_vars.find("FILEENGINE_MAX_CACHE_SIZE_MB");
    if (it != env_vars.end()) config.max_cache_size_mb = std::stoul(it->second);
    
    it = env_vars.find("FILEENGINE_MULTI_TENANT_ENABLED");
    if (it != env_vars.end()) config.multi_tenant_enabled = (it->second == "true" || it->second == "1");

    // Server configuration
    it = env_vars.find("FILEENGINE_HTTP_LISTEN_ADDR");
    if (it != env_vars.end()) config.server_address = it->second;
    
    it = env_vars.find("FILEENGINE_HTTP_LISTEN_PORT");
    if (it != env_vars.end()) config.server_port = std::stoi(it->second);
    
    it = env_vars.find("FILEENGINE_HTTP_THREAD_POOL");
    if (it != env_vars.end()) config.thread_pool_size = std::stoi(it->second);

    // Security configuration
    it = env_vars.find("FILEENGINE_ROOT_USER");
    if (it != env_vars.end()) config.root_user_enabled = (it->second == "true" || it->second == "1");

    // Sync configuration
    it = env_vars.find("FILEENGINE_S3_SYNC_SUPPORT");
    if (it != env_vars.end()) config.sync_enabled = (it->second == "true" || it->second == "minio" || it->second == "s3");
    
    it = env_vars.find("FILEENGINE_S3_RETRY_SECONDS");
    if (it != env_vars.end()) config.sync_retry_seconds = std::stoi(it->second);

    // Logging configuration
    if (env_vars.count("FILEENGINE_LOG_LEVEL")) config.log_level = env_vars.at("FILEENGINE_LOG_LEVEL");
    if (env_vars.count("FILEENGINE_LOG_FILE_PATH")) config.log_file_path = env_vars.at("FILEENGINE_LOG_FILE_PATH");
    if (env_vars.count("FILEENGINE_LOG_TO_CONSOLE")) config.log_to_console = (env_vars.at("FILEENGINE_LOG_TO_CONSOLE") == "true");
    if (env_vars.count("FILEENGINE_LOG_TO_FILE")) config.log_to_file = (env_vars.at("FILEENGINE_LOG_TO_FILE") == "true");
    if (env_vars.count("FILEENGINE_LOG_ROTATION_SIZE_MB")) config.log_rotation_size_mb = std::stoul(env_vars.at("FILEENGINE_LOG_ROTATION_SIZE_MB"));
    if (env_vars.count("FILEENGINE_LOG_RETENTION_DAYS")) config.log_retention_days = std::stoi(env_vars.at("FILEENGINE_LOG_RETENTION_DAYS"));

    return config;
}

Config ConfigLoader::load_from_env() {
    Config config;

    // Load from environment variables, with defaults
    config.db_host = get_env_var("FILEENGINE_DB_HOST", config.db_host);
    config.db_port = std::stoi(get_env_var("FILEENGINE_DB_PORT", std::to_string(config.db_port)));
    config.db_name = get_env_var("FILEENGINE_DB_NAME", config.db_name);
    config.db_user = get_env_var("FILEENGINE_DB_USER", config.db_user);
    config.db_password = get_env_var("FILEENGINE_DB_PASSWORD", config.db_password);

    config.storage_base_path = get_env_var("FILEENGINE_STORAGE_BASE_PATH", config.storage_base_path);
    config.encrypt_data = (get_env_var("FILEENGINE_ENCRYPT_DATA", config.encrypt_data ? "true" : "false") == "true");
    config.compress_data = (get_env_var("FILEENGINE_COMPRESS_DATA", config.compress_data ? "true" : "false") == "true");

    config.s3_endpoint = get_env_var("FILEENGINE_S3_ENDPOINT", config.s3_endpoint);
    config.s3_region = get_env_var("FILEENGINE_S3_REGION", config.s3_region);
    config.s3_bucket = get_env_var("FILEENGINE_S3_BUCKET", config.s3_bucket);
    config.s3_access_key = get_env_var("FILEENGINE_S3_ACCESS_KEY", config.s3_access_key);
    config.s3_secret_key = get_env_var("FILEENGINE_S3_SECRET_KEY", config.s3_secret_key);
    config.s3_path_style = (get_env_var("FILEENGINE_S3_PATH_STYLE", config.s3_path_style ? "true" : "false") == "true");

    config.cache_threshold = std::stod(get_env_var("FILEENGINE_CACHE_THRESHOLD", std::to_string(config.cache_threshold)));
    config.max_cache_size_mb = std::stoul(get_env_var("FILEENGINE_MAX_CACHE_SIZE_MB", std::to_string(config.max_cache_size_mb)));
    config.multi_tenant_enabled = (get_env_var("FILEENGINE_MULTI_TENANT_ENABLED", config.multi_tenant_enabled ? "true" : "false") == "true");

    // Server configuration
    config.server_address = get_env_var("FILEENGINE_SERVER_ADDRESS", config.server_address);
    config.server_port = std::stoi(get_env_var("FILEENGINE_SERVER_PORT", std::to_string(config.server_port)));
    config.thread_pool_size = std::stoi(get_env_var("FILEENGINE_HTTP_THREAD_POOL", std::to_string(config.thread_pool_size)));

    // Security configuration
    config.root_user_enabled = (get_env_var("FILEENGINE_ROOT_USER", config.root_user_enabled ? "true" : "false") == "true");

    // Sync configuration
    config.sync_enabled = (get_env_var("FILEENGINE_S3_SYNC_ENABLED", "true") == "true");
    config.sync_retry_seconds = std::stoi(get_env_var("FILEENGINE_S3_RETRY_SECONDS", std::to_string(config.sync_retry_seconds)));
    config.sync_on_startup = (get_env_var("FILEENGINE_S3_SYNC_ON_STARTUP", config.sync_on_startup ? "true" : "false") == "true");
    config.sync_on_demand = (get_env_var("FILEENGINE_S3_SYNC_ON_DEMAND", config.sync_on_demand ? "true" : "false") == "true");
    config.sync_pattern = get_env_var("FILEENGINE_S3_SYNC_PATTERN", config.sync_pattern);
    config.sync_bidirectional = (get_env_var("FILEENGINE_S3_SYNC_BIDIRECTIONAL", config.sync_bidirectional ? "true" : "false") == "true");

    // Logging configuration
    config.log_level = get_env_var("FILEENGINE_LOG_LEVEL", config.log_level);
    config.log_file_path = get_env_var("FILEENGINE_LOG_FILE_PATH", config.log_file_path);
    config.log_to_console = (get_env_var("FILEENGINE_LOG_TO_CONSOLE", config.log_to_console ? "true" : "false") == "true");
    config.log_to_file = (get_env_var("FILEENGINE_LOG_TO_FILE", config.log_to_file ? "true" : "false") == "true");
    config.log_rotation_size_mb = std::stoul(get_env_var("FILEENGINE_LOG_ROTATION_SIZE_MB", std::to_string(config.log_rotation_size_mb)));
    config.log_retention_days = std::stoi(get_env_var("FILEENGINE_LOG_RETENTION_DAYS", std::to_string(config.log_retention_days)));

    return config;
}

Config ConfigLoader::load_from_cmd_args(int argc, char* argv[]) {
    Config config;
    
    // For now, we're not parsing command-line arguments
    // This would be implemented based on specific requirements
    // Example parsing could be added here
    
    return config;
}

Config ConfigLoader::load_config(int argc, char* argv[]) {
    Config config;

    // 1. Load from .env file if it exists
    Config file_config = load_from_file(".env");
    config = file_config;  // Assign file config as base

    // 2. Load from environment variables (override file config)
    Config env_config = load_from_env();

    // Database config overrides - check if env vars are set, then use the same-named vars from env_config
    if (getenv("FILEENGINE_PG_HOST")) config.db_host = env_config.db_host;
    if (getenv("FILEENGINE_PG_PORT")) config.db_port = env_config.db_port;
    if (getenv("FILEENGINE_PG_DATABASE")) config.db_name = env_config.db_name;
    if (getenv("FILEENGINE_PG_USER")) config.db_user = env_config.db_user;
    if (getenv("FILEENGINE_PG_PASSWORD")) config.db_password = env_config.db_password;

    // Storage config overrides
    if (getenv("FILEENGINE_STORAGE_BASE")) config.storage_base_path = env_config.storage_base_path;
    if (getenv("FILEENGINE_ENCRYPT_DATA")) config.encrypt_data = env_config.encrypt_data;
    if (getenv("FILEENGINE_COMPRESS_DATA")) config.compress_data = env_config.compress_data;

    // S3 config overrides
    if (getenv("FILEENGINE_S3_ENDPOINT")) config.s3_endpoint = env_config.s3_endpoint;
    if (getenv("FILEENGINE_S3_REGION")) config.s3_region = env_config.s3_region;
    if (getenv("FILEENGINE_S3_BUCKET")) config.s3_bucket = env_config.s3_bucket;
    if (getenv("FILEENGINE_S3_ACCESS_KEY")) config.s3_access_key = env_config.s3_access_key;
    if (getenv("FILEENGINE_S3_SECRET_KEY")) config.s3_secret_key = env_config.s3_secret_key;
    if (getenv("FILEENGINE_S3_PATH_STYLE")) config.s3_path_style = env_config.s3_path_style;

    // Cache config overrides
    if (getenv("FILEENGINE_CACHE_THRESHOLD")) config.cache_threshold = env_config.cache_threshold;
    if (getenv("FILEENGINE_MAX_CACHE_SIZE_MB")) config.max_cache_size_mb = env_config.max_cache_size_mb;

    // Tenant config overrides
    if (getenv("FILEENGINE_MULTI_TENANT_ENABLED")) config.multi_tenant_enabled = env_config.multi_tenant_enabled;

    // Server config overrides
    if (getenv("FILEENGINE_GRPC_HOST")) config.server_address = env_config.server_address;
    if (getenv("FILEENGINE_GRPC_PORT")) config.server_port = env_config.server_port;
    if (getenv("FILEENGINE_HTTP_THREAD_POOL")) config.thread_pool_size = env_config.thread_pool_size;

    // Security config overrides
    if (getenv("FILEENGINE_ROOT_USER")) config.root_user_enabled = env_config.root_user_enabled;

    // Sync config overrides
    if (getenv("FILEENGINE_S3_SYNC_SUPPORT")) config.sync_enabled = env_config.sync_enabled;
    if (getenv("FILEENGINE_S3_RETRY_SECONDS")) config.sync_retry_seconds = env_config.sync_retry_seconds;
    if (getenv("FILEENGINE_S3_SYNC_ON_STARTUP")) config.sync_on_startup = env_config.sync_on_startup;
    if (getenv("FILEENGINE_S3_SYNC_ON_DEMAND")) config.sync_on_demand = env_config.sync_on_demand;
    if (getenv("FILEENGINE_S3_SYNC_PATTERN")) config.sync_pattern = env_config.sync_pattern;
    if (getenv("FILEENGINE_S3_SYNC_BIDIRECTIONAL")) config.sync_bidirectional = env_config.sync_bidirectional;

    // Logging config overrides
    if (getenv("FILEENGINE_LOG_LEVEL")) config.log_level = env_config.log_level;
    if (getenv("FILEENGINE_LOG_FILE_PATH")) config.log_file_path = env_config.log_file_path;
    if (getenv("FILEENGINE_LOG_TO_CONSOLE")) config.log_to_console = env_config.log_to_console;
    if (getenv("FILEENGINE_LOG_TO_FILE")) config.log_to_file = env_config.log_to_file;
    if (getenv("FILEENGINE_LOG_ROTATION_SIZE_MB")) config.log_rotation_size_mb = env_config.log_rotation_size_mb;
    if (getenv("FILEENGINE_LOG_RETENTION_DAYS")) config.log_retention_days = env_config.log_retention_days;

    // 3. Load from command-line arguments (override env and file configs)
    Config cmd_config = load_from_cmd_args(argc, argv);
    // For command-line args, we only override if they're legitimately different from defaults
    if (cmd_config.db_host != config.db_host) config.db_host = cmd_config.db_host;
    if (cmd_config.db_port != config.db_port) config.db_port = cmd_config.db_port;
    if (cmd_config.db_name != config.db_name) config.db_name = cmd_config.db_name;
    if (cmd_config.db_user != config.db_user) config.db_user = cmd_config.db_user;
    if (cmd_config.db_password != config.db_password) config.db_password = cmd_config.db_password;
    if (cmd_config.storage_base_path != config.storage_base_path) config.storage_base_path = cmd_config.storage_base_path;
    if (cmd_config.s3_endpoint != config.s3_endpoint) config.s3_endpoint = cmd_config.s3_endpoint;
    if (cmd_config.s3_region != config.s3_region) config.s3_region = cmd_config.s3_region;
    if (cmd_config.s3_bucket != config.s3_bucket) config.s3_bucket = cmd_config.s3_bucket;
    if (cmd_config.s3_access_key != config.s3_access_key) config.s3_access_key = cmd_config.s3_access_key;
    if (cmd_config.s3_secret_key != config.s3_secret_key) config.s3_secret_key = cmd_config.s3_secret_key;
    if (cmd_config.server_address != config.server_address) config.server_address = cmd_config.server_address;
    if (cmd_config.server_port != config.server_port) config.server_port = cmd_config.server_port;
    if (cmd_config.thread_pool_size != config.thread_pool_size) config.thread_pool_size = cmd_config.thread_pool_size;
    if (cmd_config.root_user_enabled != config.root_user_enabled) config.root_user_enabled = cmd_config.root_user_enabled;
    
    return config;
}

} // namespace fileengine